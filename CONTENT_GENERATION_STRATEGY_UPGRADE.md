# **内容生成策略升级方案**

**文档目的:** 本文档旨在全面阐述内容生成流程的优化方案，确保团队成员，即使未参与前期讨论，也能完全理解方案的背景、演进过程、具体实施细节及预期目标。

---

## 1. 背景：问题的提出

我们当前的自动化课程生成管线（`run_full_langgraph_pipeline.py`）虽然能够产出结构完整、内容详实的大纲和独立的知识点，但在将这些知识点组合成连贯的课程时，暴露出一个核心问题：**内容的“割裂感”**。

学习者在阅读由该系统生成的连续知识点时，感觉像是在阅读一本由互不相干的词条组成的百科全书，而不是一本精心编排、具有流畅叙事线的教科书。每个知识点都像一个孤岛，缺乏与“上下文”的有机连接，极大地影响了学习体验。

## 2. 前因后果：方案的演进与思想迭代

为了解决“割裂感”问题，我们的思考经历了一个从表面到本质、逐步深入的演进过程：

1.  **初步诊断与方案 (V1):** 我们最初认为问题在于缺少上下文。因此，提出了“上下文注入”方案，即在生成每个知识点时，将前一个知识点的内容作为“引子”或“前情提要”提供给AI。

2.  **深入洞察 (V2):** 我们很快意识到，并非所有知识都需要强叙事性。通过对比“Python基础”和“NLP预处理”两个主题，我们抽象出了两种核心的知识结构模型：
    *   **工具箱 (Toolbox):** 知识单元相对独立，可并行学习（如Python的数据结构）。
    *   **流水线 (Pipeline):** 知识单元间存在强依赖和时序关系，必须串行学习（如NLP的预处理流程）。
    这一洞察让我们明白，**内容生成策略必须与知识结构相匹配**。

3.  **结构化方案 (V3):** 基于V2的认知，我们设计了一套“结构感知”的大纲生成系统。通过改造`generate_outline_pipeline.py`，我们让AI在生成大纲时，就为每个模块（小节）打上`structure_type: "pipeline" | "toolbox"`的标签。这为后续差异化的内容生成提供了“指令”。

4.  **最终方案的诞生 (V4 - 当前方案):** 在设计如何利用上述“指令”时，我们迎来了最终的、也是最关键的突破。我们意识到：
    *   **对于`toolbox`结构，** 采用“融合式Prompt”（上下文+核心要点清单）是合适的，因为每个“工具”都值得一次全面的介绍。
    *   **对于`pipeline`结构，** 任何固定的模板（即使是提炼后的清单）都是一种束缚，会破坏其内在的叙事流。最佳策略是：**将同一个流水线小节内已生成的所有内容作为完整的上文，让AI自主、自然地进行“续写”**。
    *   同时，为了保证“续写”的质量下限，我们引入了**“建议内容模块清单”**（如`include_code_example`, `include_common_mistake_warning`），取代了旧的`switches`体系，要求AI在续写时，根据教学需要“酌情”使用这些增强表现力的内容模块。

至此，我们形成了一套最先进、最优雅的解决方案：“上下文驱动”+“精炼开关”。

## 3. 具体更改方式：`run_full_langgraph_pipeline.py`的改造

为了实现最终方案（V4），我们需要对现有的内容生成节点（`generate_and_review_by_chapter_node`）进行一次核心重构。旧的、完全并行的生成方式将被新的、**“按组串行”**的生成方式所取代。

我们将引入一个新的核心生成节点，例如`generate_content_sequentially_node`，其工作逻辑如下：

1.  **外层循环 (按章节、小节):** 程序将严格按照大纲的章节（Chapter）和小节（Group）顺序进行遍历。

2.  **内层循环 (按知识点，串行生成):** 在进入任何一个小节（Group）时，启动一个内部循环，按顺序逐一生成该小节下的所有知识点（Section）。

3.  **上下文累积:** 在小节内部，维护一个`group_context`字符串变量。每当一个知识点生成完毕后，其内容被追加到`group_context`中。

4.  **动态Prompt构建:** 在生成第 N 个知识点时，执行以下操作来构建Prompt：
    a.  读取第 1 到 N-1 个知识点的完整内容（即当前的`group_context`）。
    b.  读取第 N 个知识点的`title`, `primary_goal`, 和`switches`（现在是“建议内容模块清单”）。
    c.  构建一个包含【已完成的章节内容】、【你的当前任务】和【内容表现形式要求】的“柔性Prompt”。

5.  **调用与更新:** 调用LLM生成内容，然后将新内容追加到`group_context`，为生成第 N+1 个知识点做准备。

这个新的生成节点将取代旧的`generate_and_review_by_chapter_node`和`derive_prompts_node`的核心功能，因为Prompt的构建与内容生成过程现在是紧密耦合的。

## 4. 期望达到的目的

通过本次改造，我们期望达到以下目标：

*   **根除内容的“割裂感”:** 实现真正意义上的上下文感知生成，确保知识点之间的过渡自然、无缝，形成连贯的叙事流。
*   **提升内容质量与深度:** 通过“建议内容模块清单”，在保持叙事灵活性的同时，确保每个知识点都包含必要的、高质量的内容组件（如代码、示例、图表等），保证教学质量的下限。
*   **实现策略与结构的统一:** 使内容生成策略（如何写）与知识内在结构（写什么）完美匹配，为不同类型的知识模块（流水线/工具箱）提供最适合的呈现方式。
*   **系统智能化升级:** 整个内容生成系统将从一个“机械执行者”进化为一个更懂教学设计的“智能创作者”。

## 5. 可能涉及的改动

*   **主要改动文件:** `run_full_langgraph_pipeline.py`
*   **核心改动部分:**
    *   需要**重写或替换**现有的内容生成节点`generate_and_review_by_chapter_node`。
    *   需要**新增**一个用于构建“上下文驱动柔性Prompt”的函数，例如`build_contextual_content_prompt`。
    *   原有的`derive_prompts_node`节点的功能将被吸收进新的生成节点中，可以被移除或改造。
    *   `WorkState`中`drafts`字段的填充方式将从一次性并行填充，变为在生成节点中逐步累积填充。
    *   `build_graph`函数需要更新，将流程的边指向新的生成节点。
*   **依赖:** 本次改造强依赖于`generate_outline_pipeline.py`已经能生成带有`structure_type`和`primary_goal`+`switches`元数据的大纲。
