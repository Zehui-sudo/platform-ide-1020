å¥½çš„ï¼Œä½œä¸ºä¸€åä¸–ç•Œçº§çš„æŠ€æœ¯æ•™è‚²è€…å’Œ Python ä¸“å®¶ï¼Œæˆ‘å°†æ— ç¼è¡”æ¥ä¹‹å‰çš„å†…å®¹ï¼Œç»§ç»­ä¸ºæ‚¨ç²¾å¿ƒæ‰“é€ è¿™ç¯‡é«˜è´¨é‡çš„ Markdown æ•™ç¨‹ã€‚

---

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

å½“å¤šä¸ªçº¿ç¨‹éœ€è¦**åŒæ—¶è®¿é—®å’Œä¿®æ”¹åŒä¸€ä¸ªå…±äº«èµ„æº**ï¼ˆä¾‹å¦‚ä¸€ä¸ªå…¨å±€å˜é‡ï¼‰æ—¶ï¼Œå¦‚æœä¸å¯¹è®¿é—®è¿›è¡Œæ§åˆ¶ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®é”™ä¹±ã€ç»“æœä¸å¯é¢„æµ‹ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¸º**â€œç«æ€æ¡ä»¶â€ (Race Condition)**ã€‚çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œå¦‚é” (Lock)ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¡®ä¿åœ¨ä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ“ä½œå…±äº«èµ„æºï¼Œä»è€Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚

### ğŸ’¡ ä½¿ç”¨æ–¹å¼

Python çš„ `threading` æ¨¡å—æä¾›äº† `Lock` å¯¹è±¡æ¥è§£å†³ç«æ€æ¡ä»¶ã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨ `lock.acquire()` æ¥è·å–é”ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿå°è¯•è·å–è¯¥é”ï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æŒæœ‰é”çš„çº¿ç¨‹è°ƒç”¨ `lock.release()` é‡Šæ”¾é”ä¸ºæ­¢ã€‚æ›´æ¨èã€æ›´å®‰å…¨çš„æ–¹å¼æ˜¯ä½¿ç”¨ `with` è¯­å¥ï¼Œå®ƒèƒ½è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ï¼Œå³ä½¿åœ¨ä»£ç å—ä¸­å‘ç”Ÿå¼‚å¸¸ä¹Ÿèƒ½ä¿è¯é”è¢«é‡Šæ”¾ã€‚

### ğŸ“š Level 1: åŸºç¡€è®¤çŸ¥ï¼ˆ30ç§’ç†è§£ï¼‰

æƒ³è±¡ä¸€ä¸‹ï¼Œä¸¤ä¸ªæ”¶é“¶å‘˜ï¼ˆçº¿ç¨‹ï¼‰åŒæ—¶æ“ä½œåŒä¸€ä¸ªé“¶è¡Œè´¦æˆ·ï¼ˆå…±äº«å˜é‡ï¼‰ã€‚å¦‚æœä¸åŠ æ§åˆ¶ï¼Œè´¦æˆ·ä½™é¢å°±ä¼šç®—é”™ã€‚

```python
import threading
import time

# å…±äº«èµ„æºï¼šé“¶è¡Œè´¦æˆ·ä½™é¢
balance = 0
# åˆ›å»ºä¸€ä¸ªé”
lock = threading.Lock()

def deposit(amount):
    """æ¨¡æ‹Ÿå­˜æ¬¾æ“ä½œ"""
    global balance
    # è¯»å–å½“å‰ä½™é¢
    current_balance = balance
    # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
    time.sleep(0.01)
    # è®¡ç®—æ–°ä½™é¢å¹¶å†™å…¥
    balance = current_balance + amount

def run_threads_without_lock(n_threads):
    """ä¸ä½¿ç”¨é”ï¼Œä¼šäº§ç”Ÿç«æ€æ¡ä»¶"""
    global balance
    balance = 0
    threads = []
    for _ in range(n_threads):
        thread = threading.Thread(target=deposit, args=(1,))
        threads.append(thread)
        thread.start()
    for thread in threads:
        thread.join()
    print(f"ä¸ä½¿ç”¨é”ï¼Œ{n_threads} ä¸ªçº¿ç¨‹æ¯ä¸ªå­˜å…¥1å…ƒï¼Œæœ€ç»ˆä½™é¢: {balance}")

def run_threads_with_lock(n_threads):
    """ä½¿ç”¨ with lock: è¯­å¥ä¿æŠ¤å…±äº«èµ„æº"""
    global balance
    balance = 0
    
    def locked_deposit(amount):
        global balance
        with lock: # withè¯­å¥è‡ªåŠ¨è·å–å’Œé‡Šæ”¾é”
            current_balance = balance
            time.sleep(0.01)
            balance = current_balance + amount

    threads = []
    for _ in range(n_threads):
        thread = threading.Thread(target=locked_deposit, args=(1,))
        threads.append(thread)
        thread.start()
    for thread in threads:
        thread.join()
    print(f"ä½¿ç”¨é”åï¼Œ{n_threads} ä¸ªçº¿ç¨‹æ¯ä¸ªå­˜å…¥1å…ƒï¼Œæœ€ç»ˆä½™é¢: {balance}")


# è¿è¡Œç¤ºä¾‹
THREAD_COUNT = 100
run_threads_without_lock(THREAD_COUNT)
run_threads_with_lock(THREAD_COUNT)

# é¢„æœŸè¾“å‡ºç»“æœ (ä¸ä½¿ç”¨é”çš„ç»“æœå¯èƒ½æ¯æ¬¡éƒ½ä¸åŒï¼Œä½†å‡ ä¹æ€»æ˜¯å°äº100):
# ä¸ä½¿ç”¨é”ï¼Œ100 ä¸ªçº¿ç¨‹æ¯ä¸ªå­˜å…¥1å…ƒï¼Œæœ€ç»ˆä½™é¢: 2  <-- ç»“æœé”™è¯¯ï¼
# ä½¿ç”¨é”åï¼Œ100 ä¸ªçº¿ç¨‹æ¯ä¸ªå­˜å…¥1å…ƒï¼Œæœ€ç»ˆä½™é¢: 100 <-- ç»“æœæ­£ç¡®ï¼
```

### ğŸ“ˆ Level 2: æ ¸å¿ƒç‰¹æ€§ï¼ˆæ·±å…¥ç†è§£ï¼‰

#### ç‰¹æ€§1: å¯é‡å…¥é” (RLock)

ä¸€ä¸ªçº¿ç¨‹åœ¨å·²ç»æŒæœ‰æ™®é€š `Lock` çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå†æ¬¡å°è¯•è·å–è¯¥é”ï¼Œå°†ä¼šé€ æˆ**æ­»é” (Deadlock)**ï¼Œç¨‹åºä¼šæ°¸è¿œé˜»å¡ã€‚`RLock` (Re-entrant Lock) å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€ä¸ªé”ï¼Œè€Œä¸ä¼šé€ æˆæ­»é”ã€‚è¿™åœ¨å¤æ‚çš„å‡½æ•°è°ƒç”¨æˆ–é€’å½’åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

```python
import threading

# ä½¿ç”¨æ™®é€šé”åœ¨åµŒå¥—å‡½æ•°ä¸­ä¼šæ­»é”
lock = threading.Lock()
# ä½¿ç”¨å¯é‡å…¥é”åˆ™å¯ä»¥æ­£å¸¸å·¥ä½œ
rlock = threading.RLock()

def complex_operation_deadlock():
    print("çº¿ç¨‹å°è¯•è·å– lock...")
    lock.acquire()
    print("çº¿ç¨‹å·²è·å– lockï¼Œå‡†å¤‡è¿›å…¥å†…å±‚å‡½æ•°...")
    inner_operation_deadlock()
    lock.release()
    print("çº¿ç¨‹å·²é‡Šæ”¾ lockã€‚")

def inner_operation_deadlock():
    print("å†…å±‚å‡½æ•°å°è¯•å†æ¬¡è·å– lock...")
    lock.acquire() # è¿™é‡Œä¼šæ°¸è¿œé˜»å¡ï¼Œå› ä¸ºå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰è¯¥é”
    print("è¿™è¡Œä»£ç æ°¸è¿œä¸ä¼šæ‰§è¡Œ")
    lock.release()

def complex_operation_with_rlock():
    print("çº¿ç¨‹å°è¯•è·å– rlock...")
    rlock.acquire()
    print("çº¿ç¨‹å·²è·å– rlockï¼Œå‡†å¤‡è¿›å…¥å†…å±‚å‡½æ•°...")
    inner_operation_with_rlock()
    rlock.release()
    print("çº¿ç¨‹å·²é‡Šæ”¾ rlockã€‚")

def inner_operation_with_rlock():
    print("å†…å±‚å‡½æ•°å°è¯•å†æ¬¡è·å– rlock...")
    rlock.acquire() # RLockå…è®¸åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–
    print("RLock è·å–æˆåŠŸï¼æ“ä½œå¯ä»¥ç»§ç»­ã€‚")
    rlock.release()

print("--- æ¼”ç¤ºæ™®é€š Lock çš„æ­»é” ---")
# deadlock_thread = threading.Thread(target=complex_operation_deadlock)
# deadlock_thread.start()
# deadlock_thread.join(timeout=2)
# if deadlock_thread.is_alive():
#     print("çº¿ç¨‹å‘ç”Ÿæ­»é”ï¼\n")
# (ä¸ºé˜²æ­¢ç¨‹åºå¡ä½ï¼Œä»¥ä¸Šä»£ç å·²æ³¨é‡Šï¼Œå¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Šæµ‹è¯•)
print("æ™®é€š Lock åœ¨åµŒå¥—è·å–æ—¶ä¼šæ­»é”ã€‚\n")

print("--- æ¼”ç¤º RLock çš„æ­£ç¡®å·¥ä½œ ---")
rlock_thread = threading.Thread(target=complex_operation_with_rlock)
rlock_thread.start()
rlock_thread.join()
print("RLock æ¼”ç¤ºå®Œæˆã€‚")

# é¢„æœŸè¾“å‡ºç»“æœ:
# --- æ¼”ç¤ºæ™®é€š Lock çš„æ­»é” ---
# æ™®é€š Lock åœ¨åµŒå¥—è·å–æ—¶ä¼šæ­»é”ã€‚
#
# --- æ¼”ç¤º RLock çš„æ­£ç¡®å·¥ä½œ ---
# çº¿ç¨‹å°è¯•è·å– rlock...
# çº¿ç¨‹å·²è·å– rlockï¼Œå‡†å¤‡è¿›å…¥å†…å±‚å‡½æ•°...
# å†…å±‚å‡½æ•°å°è¯•å†æ¬¡è·å– rlock...
# RLock è·å–æˆåŠŸï¼æ“ä½œå¯ä»¥ç»§ç»­ã€‚
# çº¿ç¨‹å·²é‡Šæ”¾ rlockã€‚
# RLock æ¼”ç¤ºå®Œæˆã€‚
```

#### ç‰¹æ€§2: ä¿¡å·é‡ (Semaphore)

`Semaphore` æ˜¯ä¸€ç§æ›´é«˜çº§çš„é”æœºåˆ¶ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ã€‚æ¯æ¬¡è°ƒç”¨ `acquire()` æ—¶è®¡æ•°å™¨å‡1ï¼Œè°ƒç”¨ `release()` æ—¶è®¡æ•°å™¨åŠ 1ã€‚å½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œ`acquire()` ä¼šé˜»å¡ã€‚è¿™ä½¿å¾— `Semaphore` éå¸¸é€‚åˆç”¨æ¥**é™åˆ¶èƒ½å¤ŸåŒæ—¶è®¿é—®æŸä¸€èµ„æºï¼ˆå¦‚æ•°æ®åº“è¿æ¥æ± ã€APIè°ƒç”¨é™æµï¼‰çš„çº¿ç¨‹æ•°é‡**ã€‚

```python
import threading
import time
import random

# åˆ›å»ºä¸€ä¸ªå€¼ä¸º3çš„ä¿¡å·é‡ï¼Œè¡¨ç¤ºæœ€å¤šå…è®¸3ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®èµ„æº
semaphore = threading.Semaphore(3)

def access_database(thread_id):
    """æ¨¡æ‹Ÿä¸€ä¸ªè®¿é—®æ•°æ®åº“çš„çº¿ç¨‹"""
    print(f"çº¿ç¨‹ {thread_id}: ç­‰å¾…è®¿é—®æ•°æ®åº“...")
    with semaphore:
        # withè¯­å¥è‡ªåŠ¨ç®¡ç†acquireå’Œrelease
        print(f"âœ… çº¿ç¨‹ {thread_id}: å·²è¿æ¥åˆ°æ•°æ®åº“ã€‚æ­£åœ¨å¤„ç†ä¸šåŠ¡...")
        time.sleep(random.uniform(1, 2)) # æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œè€—æ—¶
        print(f"çº¿ç¨‹ {thread_id}: æ“ä½œå®Œæˆï¼Œæ–­å¼€è¿æ¥ã€‚")

threads = []
# åˆ›å»º5ä¸ªçº¿ç¨‹ï¼Œä½†ä¿¡å·é‡åªå…è®¸3ä¸ªå¹¶å‘æ‰§è¡Œ
for i in range(5):
    thread = threading.Thread(target=access_database, args=(i,))
    threads.append(thread)
    thread.start()

for thread in threads:
    thread.join()

# é¢„æœŸè¾“å‡ºç»“æœ (ä½ ä¼šçœ‹åˆ°åŒæ—¶æœ€å¤šåªæœ‰3ä¸ªçº¿ç¨‹åœ¨å¤„ç†ä¸šåŠ¡):
# çº¿ç¨‹ 0: ç­‰å¾…è®¿é—®æ•°æ®åº“...
# âœ… çº¿ç¨‹ 0: å·²è¿æ¥åˆ°æ•°æ®åº“ã€‚æ­£åœ¨å¤„ç†ä¸šåŠ¡...
# çº¿ç¨‹ 1: ç­‰å¾…è®¿é—®æ•°æ®åº“...
# âœ… çº¿ç¨‹ 1: å·²è¿æ¥åˆ°æ•°æ®åº“ã€‚æ­£åœ¨å¤„ç†ä¸šåŠ¡...
# çº¿ç¨‹ 2: ç­‰å¾…è®¿é—®æ•°æ®åº“...
# âœ… çº¿ç¨‹ 2: å·²è¿æ¥åˆ°æ•°æ®åº“ã€‚æ­£åœ¨å¤„ç†ä¸šåŠ¡...
# çº¿ç¨‹ 3: ç­‰å¾…è®¿é—®æ•°æ®åº“...
# çº¿ç¨‹ 4: ç­‰å¾…è®¿é—®æ•°æ®åº“...
# çº¿ç¨‹ 0: æ“ä½œå®Œæˆï¼Œæ–­å¼€è¿æ¥ã€‚
# âœ… çº¿ç¨‹ 3: å·²è¿æ¥åˆ°æ•°æ®åº“ã€‚æ­£åœ¨å¤„ç†ä¸šåŠ¡...
# çº¿ç¨‹ 1: æ“ä½œå®Œæˆï¼Œæ–­å¼€è¿æ¥ã€‚
# âœ… çº¿ç¨‹ 4: å·²è¿æ¥åˆ°æ•°æ®åº“ã€‚æ­£åœ¨å¤„ç†ä¸šåŠ¡...
# ... (åç»­è¾“å‡º)
```

### ğŸ” Level 3: å¯¹æ¯”å­¦ä¹ ï¼ˆé¿å…é™·é˜±ï¼‰

**é™·é˜±ï¼šæ­»é” (Deadlock)**

å½“ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œå¹¶ä¸”ç­‰å¾…å¯¹æ–¹é‡Šæ”¾æ—¶ï¼Œå°±ä¼šå½¢æˆæ­»é”ã€‚æ‰€æœ‰ç›¸å…³çº¿ç¨‹éƒ½ä¼šè¢«æ— é™æœŸåœ°é˜»å¡ï¼Œç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œã€‚æœ€å¸¸è§çš„æ­»é”åŸå› æ˜¯**ä»¥ä¸åŒçš„é¡ºåºè·å–å¤šä¸ªé”**ã€‚

```python
import threading
import time

# ä¸¤ä¸ªå…±äº«èµ„æºï¼Œåˆ†åˆ«ç”±ä¸¤ä¸ªé”ä¿æŠ¤
fork = threading.Lock()
knife = threading.Lock()

def philosopher_A():
    """å“²å­¦å®¶A: å…ˆæ‹¿å‰å­ï¼Œå†æ‹¿åˆ€å­"""
    print("å“²å­¦å®¶ A æ€è€ƒä¸­...")
    time.sleep(1)
    with fork:
        print("å“²å­¦å®¶ A æ‹¿åˆ°äº†å‰å­ã€‚")
        time.sleep(0.5)
        print("å“²å­¦å®¶ A è¯•å›¾æ‹¿åˆ€å­...")
        with knife:
            print("å“²å­¦å®¶ A æ‹¿åˆ°äº†åˆ€å­ï¼Œå¼€å§‹åƒé¥­ã€‚") # è¿™å¥å¯èƒ½æ°¸è¿œä¸ä¼šæ‰§è¡Œ

def philosopher_B():
    """å“²å­¦å®¶B: å…ˆæ‹¿åˆ€å­ï¼Œå†æ‹¿å‰å­"""
    print("å“²å­¦å®¶ B æ€è€ƒä¸­...")
    time.sleep(1)
    with knife:
        print("å“²å­¦å®¶ B æ‹¿åˆ°äº†åˆ€å­ã€‚")
        time.sleep(0.5)
        print("å“²å­¦å®¶ B è¯•å›¾æ‹¿å‰å­...")
        with fork:
            print("å“²å­¦å®¶ B æ‹¿åˆ°äº†å‰å­ï¼Œå¼€å§‹åƒé¥­ã€‚") # è¿™å¥ä¹Ÿå¯èƒ½æ°¸è¿œä¸ä¼šæ‰§è¡Œ

# === é”™è¯¯ç”¨æ³• ===
# âŒ ä»¥ä¸åŒé¡ºåºè·å–é”ï¼Œææ˜“å¯¼è‡´æ­»é”
print("--- é”™è¯¯ç”¨æ³•ï¼šå¯èƒ½å¯¼è‡´æ­»é” ---")
thread_a_wrong = threading.Thread(target=philosopher_A)
thread_b_wrong = threading.Thread(target=philosopher_B)
thread_a_wrong.start()
thread_b_wrong.start()
thread_a_wrong.join(timeout=3)
thread_b_wrong.join(timeout=3)
if thread_a_wrong.is_alive() or thread_b_wrong.is_alive():
    print("âŒ æ­»é”å‘ç”Ÿï¼ç¨‹åºå¡ä½ã€‚\n")
# è§£é‡Šä¸ºä»€ä¹ˆæ˜¯é”™çš„:
# å“²å­¦å®¶Aæ‹¿åˆ°å‰å­åï¼Œç­‰å¾…åˆ€å­ã€‚
# åŒæ—¶ï¼Œå“²å­¦å®¶Bæ‹¿åˆ°åˆ€å­åï¼Œç­‰å¾…å‰å­ã€‚
# åŒæ–¹éƒ½æŒæœ‰å¯¹æ–¹éœ€è¦çš„èµ„æºï¼Œå¹¶ç­‰å¾…å¯¹æ–¹é‡Šæ”¾ï¼Œç¨‹åºé™·å…¥åƒµå±€ã€‚

time.sleep(4) # ç­‰å¾…ä¸Šä¸€ä¸ªä¾‹å­ç»“æŸ

# === æ­£ç¡®ç”¨æ³• ===
# âœ… å§‹ç»ˆä»¥ç›¸åŒçš„ã€å›ºå®šçš„é¡ºåºè·å–æ‰€æœ‰é”
print("\n--- æ­£ç¡®ç”¨æ³•ï¼šæŒ‰å›ºå®šé¡ºåºè·å–é” ---")
def philosopher_C():
    """å“²å­¦å®¶C: å§‹ç»ˆå…ˆæ‹¿åˆ€å­ï¼Œå†æ‹¿å‰å­"""
    print("å“²å­¦å®¶ C æ€è€ƒä¸­...")
    time.sleep(1)
    with knife:
        print("å“²å­¦å®¶ C æ‹¿åˆ°äº†åˆ€å­ã€‚")
        time.sleep(0.5)
        print("å“²å­¦å®¶ C è¯•å›¾æ‹¿å‰å­...")
        with fork:
            print("âœ… å“²å­¦å®¶ C æ‹¿åˆ°äº†å‰å­ï¼Œå¼€å§‹åƒé¥­ã€‚")

thread_a_correct = threading.Thread(target=philosopher_C)
thread_b_correct = threading.Thread(target=philosopher_C)
thread_a_correct.start()
thread_b_correct.start()
thread_a_correct.join()
thread_b_correct.join()
print("âœ… ä¸¤ä½å“²å­¦å®¶éƒ½åƒå®Œé¥­äº†ã€‚")
# è§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·æ˜¯å¯¹çš„:
# é€šè¿‡è§„å®šæ‰€æœ‰çº¿ç¨‹å¿…é¡»æŒ‰åŒä¸€é¡ºåºï¼ˆä¾‹å¦‚ï¼Œå…ˆ knife å forkï¼‰è¯·æ±‚é”ï¼Œ
# ç ´åäº†æ­»é”äº§ç”Ÿçš„å¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚ä¸€ä¸ªçº¿ç¨‹è¦ä¹ˆèƒ½è·å–æ‰€æœ‰é”ï¼Œè¦ä¹ˆåœ¨ç¬¬ä¸€ä¸ªé”å°±è¢«é˜»å¡ï¼Œ
# ä¸ä¼šæŒæœ‰éƒ¨åˆ†é”å»ç­‰å¾…å…¶ä»–é”ã€‚
```

### ğŸš€ Level 4: å®æˆ˜åº”ç”¨ï¼ˆçœŸå®åœºæ™¯ï¼‰

**åœºæ™¯ï¼š** ğŸ° çŸ®äººå·¥åŒ çš„ç¬¦æ–‡é”»é€ å·¥åŠ

åœ¨çŸ®äººçš„åœ°ä¸‹åŸé‡Œï¼Œæœ‰ä¸€ä¸ªä¼ å¥‡çš„é”»é€ å·¥åŠã€‚å¤šåçŸ®äººå·¥åŒ ï¼ˆçº¿ç¨‹ï¼‰éœ€è¦ä½¿ç”¨**å”¯ä¸€çš„â€œç¬¦æ–‡é“ç §â€**ï¼ˆå…±äº«èµ„æºï¼‰å’Œæœ‰é™çš„**â€œå†·å´æ± â€**ï¼ˆä¿¡å·é‡é™åˆ¶çš„èµ„æºï¼‰æ¥é”»é€ é­”æ³•æ­¦å™¨ã€‚æˆ‘ä»¬éœ€è¦ç¡®ä¿ï¼š
1.  ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªå·¥åŒ èƒ½ä½¿ç”¨ç¬¦æ–‡é“ç §ã€‚
2.  æœ€å¤šåªèƒ½æœ‰ä¸¤ä¸ªå·¥åŒ åŒæ—¶ä½¿ç”¨å†·å´æ± ã€‚

```python
import threading
import time
import random

# å…±äº«èµ„æº
rune_anvil_lock = threading.Lock()  # ç¬¦æ–‡é“ç §ï¼Œç‹¬å èµ„æº
cooling_pool_semaphore = threading.Semaphore(2) # å†·å´æ± ï¼Œæœ€å¤šå®¹çº³2ä¸ª

def dwarf_smith(name):
    """ä¸€ä¸ªçŸ®äººå·¥åŒ çš„å·¥ä½œæµç¨‹"""
    print(f"âš’ï¸ å·¥åŒ  {name} è¿›å…¥äº†å·¥åŠã€‚")
    
    # --- é˜¶æ®µ1: ä½¿ç”¨ç¬¦æ–‡é“ç § ---
    print(f"å·¥åŒ  {name} ç­‰å¾…ä½¿ç”¨ç¬¦æ–‡é“ç §...")
    with rune_anvil_lock:
        print(f"ğŸ”¥ å·¥åŒ  {name} æ­£åœ¨ä½¿ç”¨ç¬¦æ–‡é“ç §é”»é€ ...")
        time.sleep(random.uniform(1.5, 2.5))
        print(f"âœ¨ å·¥åŒ  {name} çš„æ­¦å™¨é”»é€ å®Œæˆï¼Œç¦»å¼€é“ç §ã€‚")

    # --- é˜¶æ®µ2: ä½¿ç”¨å†·å´æ±  ---
    print(f"å·¥åŒ  {name} ç­‰å¾…ä½¿ç”¨å†·å´æ± ...")
    with cooling_pool_semaphore:
        print(f"ğŸ’§ å·¥åŒ  {name} æ­£åœ¨ä½¿ç”¨å†·å´æ± æ·¬ç«...")
        time.sleep(random.uniform(1, 2))
        print(f"ğŸ’¨ å·¥åŒ  {name} çš„æ­¦å™¨æ·¬ç«å®Œæˆï¼Œç¦»å¼€å†·å´æ± ã€‚")

    print(f"ğŸ‰ å·¥åŒ  {name} å®Œæˆäº†ä¸€ä»¶é­”æ³•æ­¦å™¨ï¼")

if __name__ == '__main__':
    dwarf_names = ["Gimli", "Balin", "Dwalin", "Thorin"]
    threads = []
    print("--- çŸ®äººå·¥åŠå¼€å·¥äº†ï¼---\n")

    for name in dwarf_names:
        thread = threading.Thread(target=dwarf_smith, args=(name,))
        threads.append(thread)
        thread.start()

    for thread in threads:
        thread.join()

    print("\n--- ä»Šå¤©æ‰€æœ‰çš„é”»é€ ä»»åŠ¡éƒ½å®Œæˆäº†ï¼ ---")

# é¢„æœŸè¾“å‡º (é¡ºåºå¯èƒ½å˜åŒ–ï¼Œä½†è§„å¾‹ä¸å˜):
# --- çŸ®äººå·¥åŠå¼€å·¥äº†ï¼---
#
# âš’ï¸ å·¥åŒ  Gimli è¿›å…¥äº†å·¥åŠã€‚
# å·¥åŒ  Gimli ç­‰å¾…ä½¿ç”¨ç¬¦æ–‡é“ç §...
# ğŸ”¥ å·¥åŒ  Gimli æ­£åœ¨ä½¿ç”¨ç¬¦æ–‡é“ç §é”»é€ ...
# âš’ï¸ å·¥åŒ  Balin è¿›å…¥äº†å·¥åŠã€‚
# å·¥åŒ  Balin ç­‰å¾…ä½¿ç”¨ç¬¦æ–‡é“ç §...  (è¢«é˜»å¡)
# âš’ï¸ å·¥åŒ  Dwalin è¿›å…¥äº†å·¥åŠã€‚
# å·¥åŒ  Dwalin ç­‰å¾…ä½¿ç”¨ç¬¦æ–‡é“ç §... (è¢«é˜»å¡)
# âš’ï¸ å·¥åŒ  Thorin è¿›å…¥äº†å·¥åŠã€‚
# å·¥åŒ  Thorin ç­‰å¾…ä½¿ç”¨ç¬¦æ–‡é“ç §... (è¢«é˜»å¡)
# âœ¨ å·¥åŒ  Gimli çš„æ­¦å™¨é”»é€ å®Œæˆï¼Œç¦»å¼€é“ç §ã€‚
# å·¥åŒ  Gimli ç­‰å¾…ä½¿ç”¨å†·å´æ± ...
# ğŸ’§ å·¥åŒ  Gimli æ­£åœ¨ä½¿ç”¨å†·å´æ± æ·¬ç«...
# ğŸ”¥ å·¥åŒ  Balin æ­£åœ¨ä½¿ç”¨ç¬¦æ–‡é“ç §é”»é€ ... (Gimlié‡Šæ”¾åï¼ŒBalinè·å¾—é”)
# âœ¨ å·¥åŒ  Balin çš„æ­¦å™¨é”»é€ å®Œæˆï¼Œç¦»å¼€é“ç §ã€‚
# å·¥åŒ  Balin ç­‰å¾…ä½¿ç”¨å†·å´æ± ...
# ğŸ’§ å·¥åŒ  Balin æ­£åœ¨ä½¿ç”¨å†·å´æ± æ·¬ç«... (å†·å´æ± è¿˜æœ‰ç©ºä½)
# ğŸ’¨ å·¥åŒ  Gimli çš„æ­¦å™¨æ·¬ç«å®Œæˆï¼Œç¦»å¼€å†·å´æ± ã€‚
# ğŸ‰ å·¥åŒ  Gimli å®Œæˆäº†ä¸€ä»¶é­”æ³•æ­¦å™¨ï¼
# ... (åç»­å·¥åŒ ä¾æ¬¡å®Œæˆ)
```

### ğŸ’¡ è®°å¿†è¦ç‚¹
- **è¦ç‚¹1**: **è®¿é—®å…±äº«èµ„æºï¼Œå¿…ä¸Šé”**ã€‚åªè¦æœ‰å¤šä¸ªçº¿ç¨‹ä¼šä¿®æ”¹åŒä¸€ä¸ªå˜é‡ï¼Œå°±å¿…é¡»ä½¿ç”¨ `Lock` æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶æ¥ä¿æŠ¤å®ƒã€‚
- **è¦ç‚¹2**: **`with lock:` æ˜¯é»„é‡‘æ³•åˆ™**ã€‚å®ƒèƒ½ä¿è¯é”åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼ˆå³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼‰éƒ½ä¼šè¢«æ­£ç¡®é‡Šæ”¾ï¼Œæ˜¯é¿å…èµ„æºæ³„æ¼å’Œæ­»é”çš„æœ€ä½³å®è·µã€‚
- **è¦ç‚¹3**: **è­¦æƒ•æ­»é”ï¼Œç»Ÿä¸€åŠ é”é¡ºåº**ã€‚å½“éœ€è¦è·å–å¤šä¸ªé”æ—¶ï¼Œç¡®ä¿æ‰€æœ‰çº¿ç¨‹éƒ½éµå¾ªå®Œå…¨ç›¸åŒçš„é¡ºåºæ¥è·å–å®ƒä»¬ï¼Œè¿™æ˜¯æ‰“ç ´æ­»é”å¾ªç¯ç­‰å¾…æ¡ä»¶çš„æœ‰æ•ˆæ–¹æ³•ã€‚

---

## 8.2.1 æ›´ç°ä»£çš„å¹¶å‘æ¥å£ï¼š`concurrent.futures`

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

`concurrent.futures` æ¨¡å—æä¾›äº†ä¸€ä¸ª**é«˜çº§ã€ç»Ÿä¸€çš„æ¥å£**æ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚å®ƒå°†çº¿ç¨‹å’Œè¿›ç¨‹çš„ç®¡ç†ç»†èŠ‚ï¼ˆå¦‚åˆ›å»ºã€å¯åŠ¨ã€åŠ å…¥ï¼‰å°è£…èµ·æ¥ï¼Œè®©ä½ èƒ½ä»¥ç›¸åŒçš„æ–¹å¼æ¥ä½¿ç”¨çº¿ç¨‹æ± å’Œè¿›ç¨‹æ± ï¼Œåªéœ€å…³æ³¨**æäº¤ä»»åŠ¡**å’Œ**è·å–ç»“æœ**ï¼Œä»è€Œæå¤§åœ°ç®€åŒ–äº†å¹¶å‘ç¼–ç¨‹ã€‚

### ğŸ’¡ ä½¿ç”¨æ–¹å¼

æ ¸å¿ƒæ˜¯ `Executor` å¯¹è±¡ï¼Œå®ƒæœ‰ä¸¤ç§å½¢å¼ï¼š`ThreadPoolExecutor`ï¼ˆçº¿ç¨‹æ± ï¼‰å’Œ `ProcessPoolExecutor`ï¼ˆè¿›ç¨‹æ± ï¼‰ã€‚
1.  åˆ›å»ºä¸€ä¸ª `Executor` å®ä¾‹ï¼ˆé€šå¸¸ä½¿ç”¨ `with` è¯­å¥ï¼‰ã€‚
2.  ä½¿ç”¨ `.submit(func, *args, **kwargs)` æ–¹æ³•æäº¤ä»»åŠ¡ï¼Œå®ƒä¼šç«‹å³è¿”å›ä¸€ä¸ª `Future` å¯¹è±¡ã€‚
3.  `Future` å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå°šæœªå®Œæˆçš„è®¡ç®—ï¼Œä½ å¯ä»¥é€šè¿‡å®ƒçš„ `.result()` æ–¹æ³•æ¥è·å–ä»»åŠ¡çš„è¿”å›å€¼ï¼ˆå¦‚æœä»»åŠ¡æœªå®Œæˆï¼Œ`.result()` ä¼šé˜»å¡ç­‰å¾…ï¼‰ã€‚

### ğŸ“š Level 1: åŸºç¡€è®¤çŸ¥ï¼ˆ30ç§’ç†è§£ï¼‰

è®©æˆ‘ä»¬ç”¨ `ThreadPoolExecutor` é‡å†™æœ¬ç« å¼€å¤´çš„â€œä¸‹è½½æ–‡ä»¶â€ç¤ºä¾‹ï¼Œä½“éªŒä¸€ä¸‹ä»£ç æœ‰å¤šç®€æ´ã€‚

```python
import concurrent.futures
import time

def fake_download(task_name):
    """æ¨¡æ‹Ÿä¸€ä¸ªéœ€è¦ç­‰å¾…I/Oçš„ä»»åŠ¡"""
    print(f"å¼€å§‹ä¸‹è½½ {task_name}...")
    time.sleep(2)
    result = f"{task_name} ä¸‹è½½å®Œæˆ!"
    print(result)
    return result

# ä½¿ç”¨ ThreadPoolExecutor
with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:
    print("--- ä½¿ç”¨ concurrent.futures å¹¶å‘æ‰§è¡Œ ---")
    start_time = time.time()
    
    # æäº¤ä»»åŠ¡ï¼Œç«‹å³è¿”å› future å¯¹è±¡
    future1 = executor.submit(fake_download, "æ–‡ä»¶C")
    future2 = executor.submit(fake_download, "æ–‡ä»¶D")
    
    # è·å–ç»“æœ (result() æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆ)
    print("ä¸»çº¿ç¨‹ï¼šç­‰å¾…ç»“æœ...")
    result1 = future1.result()
    result2 = future2.result()
    
    end_time = time.time()
    
    print(f"\nè·å–åˆ°çš„ç»“æœ: ['{result1}', '{result2}']")
    print(f"å¹¶å‘æ‰§è¡Œæ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")

# é¢„æœŸè¾“å‡ºç»“æœ:
# --- ä½¿ç”¨ concurrent.futures å¹¶å‘æ‰§è¡Œ ---
# ä¸»çº¿ç¨‹ï¼šç­‰å¾…ç»“æœ...
# å¼€å§‹ä¸‹è½½ æ–‡ä»¶C...
# å¼€å§‹ä¸‹è½½ æ–‡ä»¶D...
# æ–‡ä»¶C ä¸‹è½½å®Œæˆ!
# æ–‡ä»¶D ä¸‹è½½å®Œæˆ!
#
# è·å–åˆ°çš„ç»“æœ: ['æ–‡ä»¶C ä¸‹è½½å®Œæˆ!', 'æ–‡ä»¶D ä¸‹è½½å®Œæˆ!']
# å¹¶å‘æ‰§è¡Œæ€»è€—æ—¶: 2.01 ç§’
```

### ğŸ“ˆ Level 2: æ ¸å¿ƒç‰¹æ€§ï¼ˆæ·±å…¥ç†è§£ï¼‰

#### ç‰¹æ€§1: `executor.map` çš„æ‰¹é‡å¤„ç†

å¦‚æœä½ æƒ³å°†åŒä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°ä¸€ç³»åˆ—çš„è¾“å…¥æ•°æ®ä¸Šï¼Œ`executor.map` æ˜¯æ¯”å¤šæ¬¡è°ƒç”¨ `submit` æ›´ç®€æ´çš„é€‰æ‹©ã€‚å®ƒçš„è¡Œä¸ºç±»ä¼¼å†…ç½®çš„ `map` å‡½æ•°ï¼Œä½†ä»»åŠ¡æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚å®ƒè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œä½ å¯ä»¥æŒ‰è¾“å…¥é¡ºåºéå†ä»»åŠ¡çš„ç»“æœã€‚

```python
import concurrent.futures
import time

urls = [
    "site1.com",
    "site2.com",
    "site3.com",
    "site4.com",
]

def fetch_url(url):
    """æ¨¡æ‹Ÿè¯·æ±‚ç½‘é¡µ"""
    print(f"å¼€å§‹è¯·æ±‚ {url}...")
    time.sleep(1)
    return f"æ¥è‡ª {url} çš„å†…å®¹"

with concurrent.futures.ThreadPoolExecutor(max_workers=4) as executor:
    start_time = time.time()
    
    # executor.map ä¼šä¿æŒç»“æœçš„é¡ºåºä¸è¾“å…¥é¡ºåºä¸€è‡´
    results = executor.map(fetch_url, urls)
    
    print("ä¸»çº¿ç¨‹ï¼šå¼€å§‹éå†ç»“æœ...")
    # éå† results æ—¶ï¼Œä¼šæŒ‰é¡ºåºç­‰å¾…æ¯ä¸ªä»»åŠ¡å®Œæˆ
    for result in results:
        print(f"å¤„ç†ç»“æœ: {result}")
        
    end_time = time.time()
    print(f"\nä½¿ç”¨ map æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")

# é¢„æœŸè¾“å‡ºç»“æœ:
# å¼€å§‹è¯·æ±‚ site1.com...
# å¼€å§‹è¯·æ±‚ site2.com...
# å¼€å§‹è¯·æ±‚ site3.com...
# å¼€å§‹è¯·æ±‚ site4.com...
# ä¸»çº¿ç¨‹ï¼šå¼€å§‹éå†ç»“æœ...
# å¤„ç†ç»“æœ: æ¥è‡ª site1.com çš„å†…å®¹
# å¤„ç†ç»“æœ: æ¥è‡ª site2.com çš„å†…å®¹
# å¤„ç†ç»“æœ: æ¥è‡ª site3.com çš„å†…å®¹
# å¤„ç†ç»“æœ: æ¥è‡ª site4.com çš„å†…å®¹
#
# ä½¿ç”¨ map æ€»è€—æ—¶: 1.01 ç§’
```

#### ç‰¹æ€§2: `as_completed` å®æ—¶å“åº”

æœ‰æ—¶ä½ ä¸æƒ³æŒ‰é¡ºåºç­‰å¾…æ‰€æœ‰ä»»åŠ¡ï¼Œè€Œæ˜¯å¸Œæœ›**å“ªä¸ªä»»åŠ¡å…ˆå®Œæˆå°±å…ˆå¤„ç†å“ªä¸ª**ã€‚`concurrent.futures.as_completed()` å‡½æ•°æ¥æ”¶ä¸€ä¸ª `Future` åˆ—è¡¨ï¼Œè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨åœ¨æ¯ä¸ª `Future` å®Œæˆæ—¶äº§å‡ºå®ƒã€‚

```python
import concurrent.futures
import time
import random

def query_database(source_name):
    """æ¨¡æ‹ŸæŸ¥è¯¢ä¸åŒæ•°æ®åº“ï¼Œè€—æ—¶ä¸åŒ"""
    delay = random.uniform(0.5, 3.0)
    print(f"å¼€å§‹æŸ¥è¯¢ {source_name} (é¢„è®¡è€—æ—¶ {delay:.2f}s)...")
    time.sleep(delay)
    return f"æ¥è‡ª {source_name} çš„æ•°æ®"

sources = ["ä¸»æ•°æ®åº“", "å¤‡ä»½æ•°æ®åº“", "ç¼“å­˜æœåŠ¡å™¨"]

with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
    # æäº¤æ‰€æœ‰ä»»åŠ¡ï¼Œå¹¶å°† future å¯¹è±¡å­˜å…¥åˆ—è¡¨
    future_to_source = {executor.submit(query_database, src): src for src in sources}
    
    print("\n--- ç­‰å¾…æœ€å…ˆå®Œæˆçš„ä»»åŠ¡ ---")
    
    # as_completed ä¼šåœ¨ä»»åŠ¡å®Œæˆæ—¶ç«‹å³è¿”å›
    for future in concurrent.futures.as_completed(future_to_source):
        source = future_to_source[future]
        try:
            data = future.result()
            print(f"âœ… ä¼˜å…ˆå¤„ç†å®Œæˆçš„ç»“æœ: [{source}] -> {data}")
        except Exception as e:
            print(f"âŒ {source} æŸ¥è¯¢å¤±è´¥: {e}")

# é¢„æœŸè¾“å‡ºç»“æœ (é¡ºåºå–å†³äºéšæœºçš„å»¶è¿Ÿæ—¶é—´):
# å¼€å§‹æŸ¥è¯¢ ä¸»æ•°æ®åº“ (é¢„è®¡è€—æ—¶ 2.15s)...
# å¼€å§‹æŸ¥è¯¢ å¤‡ä»½æ•°æ®åº“ (é¢„è®¡è€—æ—¶ 0.78s)...
# å¼€å§‹æŸ¥è¯¢ ç¼“å­˜æœåŠ¡å™¨ (é¢„è®¡è€—æ—¶ 1.50s)...
#
# --- ç­‰å¾…æœ€å…ˆå®Œæˆçš„ä»»åŠ¡ ---
# âœ… ä¼˜å…ˆå¤„ç†å®Œæˆçš„ç»“æœ: [å¤‡ä»½æ•°æ®åº“] -> æ¥è‡ª å¤‡ä»½æ•°æ®åº“ çš„æ•°æ®
# âœ… ä¼˜å…ˆå¤„ç†å®Œæˆçš„ç»“æœ: [ç¼“å­˜æœåŠ¡å™¨] -> æ¥è‡ª ç¼“å­˜æœåŠ¡å™¨ çš„æ•°æ®
# âœ… ä¼˜å…ˆå¤„ç†å®Œæˆçš„ç»“æœ: [ä¸»æ•°æ®åº“] -> æ¥è‡ª ä¸»æ•°æ®åº“ çš„æ•°æ®
```

### ğŸ” Level 3: å¯¹æ¯”å­¦ä¹ ï¼ˆé¿å…é™·é˜±ï¼‰

**é™·é˜±ï¼šè¢«â€œåå™¬â€çš„å¼‚å¸¸**

å¦‚æœä¸€ä¸ªç”± `submit` æˆ– `map` æäº¤çš„ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸ä¸ä¼šç«‹å³åœ¨ä¸»çº¿ç¨‹ä¸­å¼•å‘ã€‚å®ƒä¼šè¢«æ•è·å¹¶å­˜å‚¨åœ¨ `Future` å¯¹è±¡ä¸­ã€‚å¦‚æœä½ ä»ä¸è°ƒç”¨è¯¥ `Future` çš„ `.result()` æ–¹æ³•ï¼Œä½ å°±æ°¸è¿œä¸ä¼šçŸ¥é“å‘ç”Ÿäº†é”™è¯¯ï¼

```python
import concurrent.futures
import time

def task_that_fails():
    print("ä»»åŠ¡å¼€å§‹ï¼Œå‡†å¤‡æŠ›å‡ºå¼‚å¸¸...")
    time.sleep(1)
    raise ValueError("è®¡ç®—å‡ºé”™ï¼")

# === é”™è¯¯ç”¨æ³• ===
# âŒ æäº¤ä»»åŠ¡åä¸æ£€æŸ¥ç»“æœï¼Œå¼‚å¸¸ä¼šè¢«å¿½ç•¥
print("--- é”™è¯¯ç”¨æ³•ï¼šå¼‚å¸¸è¢«åå™¬ ---")
with concurrent.futures.ThreadPoolExecutor() as executor:
    future = executor.submit(task_that_fails)
    print("ä»»åŠ¡å·²æäº¤ï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–äº‹æƒ…...")
    time.sleep(2)
    # æ²¡æœ‰è°ƒç”¨ future.result()
    print("ä¸»çº¿ç¨‹ç»“æŸï¼Œä½†ä»æœªå‘ç°åå°ä»»åŠ¡å·²å¤±è´¥ï¼")
# è§£é‡Šä¸ºä»€ä¹ˆæ˜¯é”™çš„:
# å¼‚å¸¸è¢«å­˜å‚¨åœ¨ future å¯¹è±¡é‡Œï¼Œä½†ç”±äºæˆ‘ä»¬æ²¡æœ‰è°ƒç”¨ .result() æ¥â€œè§£åŒ…â€ç»“æœï¼Œ
# å¼‚å¸¸ä¿¡æ¯å°±ä¸¢å¤±äº†ï¼Œè¿™ä¼šå¯¼è‡´ç¨‹åºåœ¨é™é»˜ä¸­å¤±è´¥ï¼Œæéš¾è°ƒè¯•ã€‚

# === æ­£ç¡®ç”¨æ³• ===
# âœ… åœ¨ try...except å—ä¸­è°ƒç”¨ .result() æ¥æ•è·å¹¶å¤„ç†å¼‚å¸¸
print("\n--- æ­£ç¡®ç”¨æ³•ï¼šæ•è·å¹¶å¤„ç†å¼‚å¸¸ ---")
with concurrent.futures.ThreadPoolExecutor() as executor:
    future = executor.submit(task_that_fails)
    print("ä»»åŠ¡å·²æäº¤ï¼Œç°åœ¨å°è¯•è·å–ç»“æœ...")
    try:
        result = future.result()
        print(f"ä»»åŠ¡æˆåŠŸï¼Œç»“æœ: {result}")
    except ValueError as e:
        print(f"âœ… æˆåŠŸæ•è·åˆ°åå°ä»»åŠ¡çš„å¼‚å¸¸: {e}")
# è§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·æ˜¯å¯¹çš„:
# è°ƒç”¨ .result() ä¼šé‡æ–°å¼•å‘ä»»åŠ¡ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå…è®¸ä¸»çº¿ç¨‹çš„ try...except å—
# æ•è·å®ƒã€‚è¿™æ˜¯å¤„ç†å¹¶å‘ä»»åŠ¡ä¸­é”™è¯¯çš„æ­£ç¡®ã€å¥å£®çš„æ–¹å¼ã€‚
```

### ğŸš€ Level 4: å®æˆ˜åº”ç”¨ï¼ˆçœŸå®åœºæ™¯ï¼‰

**åœºæ™¯ï¼š** ğŸ“œ é­”æ³•å›¾ä¹¦é¦†çš„å¤å·ä¿®å¤æµæ°´çº¿

ä¸€åº§å¤è€çš„é­”æ³•å›¾ä¹¦é¦†éœ€è¦ä¿®å¤ä¸€æ‰¹ç ´æŸçš„å¤å·ã€‚ä¿®å¤æµç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š
1.  **å‡€åŒ– (Purification)**: ä½¿ç”¨â€œå‡€åŒ–ä¹‹æ³‰â€æ¸…æ´—å¤å·ï¼Œè¿™æ˜¯ä¸€ä¸ªè€—æ—¶è¾ƒé•¿çš„I/Oæ“ä½œï¼ˆç­‰å¾…é­”æ³•èƒ½é‡æ¸—é€ï¼‰ã€‚
2.  **è½¬å½• (Transcription)**: å¯¹å‡€åŒ–åçš„å¤å·å†…å®¹è¿›è¡Œé«˜é€Ÿé­”æ³•è½¬å½•ï¼Œè¿™æ˜¯ä¸€ä¸ªCPUå¯†é›†å‹æ“ä½œï¼ˆéœ€è¦å¤§é‡è®¡ç®—æ¥è§£æç¬¦æ–‡ï¼‰ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ `concurrent.futures` æ„å»ºä¸€ä¸ªé«˜æ•ˆçš„æµæ°´çº¿ï¼Œç”¨ `ThreadPoolExecutor` å¤„ç†å‡€åŒ–ï¼Œ`ProcessPoolExecutor` å¤„ç†è½¬å½•ã€‚

```python
import concurrent.futures
import time
import os

def purify_scroll(scroll_name):
    """(I/Oå¯†é›†å‹) æ¨¡æ‹Ÿå‡€åŒ–å¤å·"""
    print(f"ğŸ’§ [I/Oçº¿ç¨‹-{os.getpid()}] å¼€å§‹å‡€åŒ– '{scroll_name}'...")
    time.sleep(2)
    purified_content = f"'{scroll_name}' çš„çº¯å‡€å†…å®¹"
    print(f"âœ¨ [I/Oçº¿ç¨‹-{os.getpid()}] '{scroll_name}' å‡€åŒ–å®Œæˆï¼")
    return purified_content

def transcribe_runes(content):
    """(CPUå¯†é›†å‹) æ¨¡æ‹Ÿè½¬å½•ç¬¦æ–‡"""
    print(f"âœï¸ [CPUè¿›ç¨‹-{os.getpid()}] å¼€å§‹è½¬å½• '{content}'...")
    # æ¨¡æ‹Ÿå¤§é‡è®¡ç®—
    n = 60_000_000
    _ = sum(i for i in range(n))
    transcribed_text = f"è½¬å½•å®Œæˆ: {content}"
    print(f"ğŸ“– [CPUè¿›ç¨‹-{os.getpid()}] '{content}' è½¬å½•å®Œæˆï¼")
    return transcribed_text

if __name__ == '__main__':
    scrolls_to_repair = ["ç«ç„°é£æš´ä¹‹å·", "æ·±åº¦å†»ç»“ä¹‹å·", "æ—¶ç©ºæ‰­æ›²ä¹‹å·"]
    
    print("--- é­”æ³•å›¾ä¹¦é¦†å¤å·ä¿®å¤æµæ°´çº¿å¯åŠ¨ ---\n")
    start_time = time.time()

    # --- é˜¶æ®µ1: ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘å‡€åŒ–å¤å· ---
    print("--- [é˜¶æ®µä¸€] å¼€å§‹å¹¶å‘å‡€åŒ– (I/Oå¯†é›†å‹) ---")
    purified_contents = []
    with concurrent.futures.ThreadPoolExecutor(max_workers=3) as purifier:
        # ä½¿ç”¨ map æ‰¹é‡å¤„ç†
        purified_contents = list(purifier.map(purify_scroll, scrolls_to_repair))
    
    print("\n--- [é˜¶æ®µä¸€] æ‰€æœ‰å¤å·å‡€åŒ–å®Œæˆ! ---\n")
    
    # --- é˜¶æ®µ2: ä½¿ç”¨è¿›ç¨‹æ± å¹¶è¡Œè½¬å½•å†…å®¹ ---
    print("--- [é˜¶æ®µäºŒ] å¼€å§‹å¹¶è¡Œè½¬å½• (CPUå¯†é›†å‹) ---")
    final_texts = []
    # os.cpu_count() or len(purified_contents) to avoid creating idle processes
    num_processes = min(os.cpu_count(), len(purified_contents))
    with concurrent.futures.ProcessPoolExecutor(max_workers=num_processes) as transcriber:
        final_texts = list(transcriber.map(transcribe_runes, purified_contents))
        
    end_time = time.time()
    
    print("\n--- ğŸ“œ æ‰€æœ‰å¤å·ä¿®å¤å®Œæˆï¼ ---")
    for text in final_texts:
        print(f"- {text}")
        
    print(f"\nâœ¨ æµæ°´çº¿æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")

# é¢„æœŸè¾“å‡º (PIDä¼šå˜åŒ–ï¼Œä½†èƒ½çœ‹å‡ºçº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«):
# --- é­”æ³•å›¾ä¹¦é¦†å¤å·ä¿®å¤æµæ°´çº¿å¯åŠ¨ ---
#
# --- [é˜¶æ®µä¸€] å¼€å§‹å¹¶å‘å‡€åŒ– (I/Oå¯†é›†å‹) ---
# ğŸ’§ [I/Oçº¿ç¨‹-12345] å¼€å§‹å‡€åŒ– 'ç«ç„°é£æš´ä¹‹å·'...
# ğŸ’§ [I/Oçº¿ç¨‹-12345] å¼€å§‹å‡€åŒ– 'æ·±åº¦å†»ç»“ä¹‹å·'...
# ğŸ’§ [I/Oçº¿ç¨‹-12345] å¼€å§‹å‡€åŒ– 'æ—¶ç©ºæ‰­æ›²ä¹‹å·'...
# âœ¨ [I/Oçº¿ç¨‹-12345] 'ç«ç„°é£æš´ä¹‹å·' å‡€åŒ–å®Œæˆï¼
# âœ¨ [I/Oçº¿ç¨‹-12345] 'æ·±åº¦å†»ç»“ä¹‹å·' å‡€åŒ–å®Œæˆï¼
# âœ¨ [I/Oçº¿ç¨‹-12345] 'æ—¶ç©ºæ‰­æ›²ä¹‹å·' å‡€åŒ–å®Œæˆï¼
#
# --- [é˜¶æ®µä¸€] æ‰€æœ‰å¤å·å‡€åŒ–å®Œæˆ! ---
#
# --- [é˜¶æ®µäºŒ] å¼€å§‹å¹¶è¡Œè½¬å½• (CPUå¯†é›†å‹) ---
# âœï¸ [CPUè¿›ç¨‹-54321] å¼€å§‹è½¬å½• ''ç«ç„°é£æš´ä¹‹å·' çš„çº¯å‡€å†…å®¹'...
# âœï¸ [CPUè¿›ç¨‹-54322] å¼€å§‹è½¬å½• ''æ·±åº¦å†»ç»“ä¹‹å·' çš„çº¯å‡€å†…å®¹'...
# âœï¸ [CPUè¿›ç¨‹-54323] å¼€å§‹è½¬å½• ''æ—¶ç©ºæ‰­æ›²ä¹‹å·' çš„çº¯å‡€å†…å®¹'...
# ğŸ“– [CPUè¿›ç¨‹-54321] ''ç«ç„°é£æš´ä¹‹å·' çš„çº¯å‡€å†…å®¹' è½¬å½•å®Œæˆï¼
# ğŸ“– [CPUè¿›ç¨‹-54322] ''æ·±åº¦å†»ç»“ä¹‹å·' çš„çº¯å‡€å†…å®¹' è½¬å½•å®Œæˆï¼
# ğŸ“– [CPUè¿›ç¨‹-54323] ''æ—¶ç©ºæ‰­æ›²ä¹‹å·' çš„çº¯å‡€å†…å®¹' è½¬å½•å®Œæˆï¼
#
# --- ğŸ“œ æ‰€æœ‰å¤å·ä¿®å¤å®Œæˆï¼ ---
# - è½¬å½•å®Œæˆ: 'ç«ç„°é£æš´ä¹‹å·' çš„çº¯å‡€å†…å®¹
# - è½¬å½•å®Œæˆ: 'æ·±åº¦å†»ç»“ä¹‹å·' çš„çº¯å‡€å†…å®¹
# - è½¬å½•å®Œæˆ: 'æ—¶ç©ºæ‰­æ›²ä¹‹å·' çš„çº¯å‡€å†…å®¹
#
# âœ¨ æµæ°´çº¿æ€»è€—æ—¶: 5.89 ç§’ (è¿œå°äºä¸²è¡Œæ€»å’Œ)
```

### ğŸ’¡ è®°å¿†è¦ç‚¹
- **è¦ç‚¹1**: **`Executor` æ˜¯å…¥å£ï¼Œ`Future` æ˜¯å‡­è¯**ã€‚é€šè¿‡ `Executor` æäº¤ä»»åŠ¡ï¼Œè·å¾—ä¸€ä¸ª `Future` å¯¹è±¡ä½œä¸ºæœªæ¥ç»“æœçš„å‡­è¯ã€‚
- **è¦ç‚¹2**: **æ¥å£ç»Ÿä¸€ï¼ŒæŒ‰éœ€åˆ‡æ¢**ã€‚`ThreadPoolExecutor` å’Œ `ProcessPoolExecutor` æ‹¥æœ‰å‡ ä¹ç›¸åŒçš„APIï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡æ˜¯I/Oå¯†é›†å‹è¿˜æ˜¯CPUå¯†é›†å‹ï¼Œè½»æ¾åœ°åœ¨å®ƒä»¬ä¹‹é—´åˆ‡æ¢ã€‚
- **è¦ç‚¹3**: **ç»“æœè™½è¿Ÿä½†åˆ°ï¼Œå¼‚å¸¸å¿…é¡»æ£€æŸ¥**ã€‚å§‹ç»ˆé€šè¿‡è°ƒç”¨ `.result()` æ¥è·å–ç»“æœï¼Œå¹¶å°†å…¶æ”¾åœ¨ `try...except` å—ä¸­ï¼Œè¿™æ˜¯å¤„ç†å¹¶å‘ä»»åŠ¡ä¸­æ½œåœ¨é”™è¯¯çš„å”¯ä¸€å¯é æ–¹æ³•ã€‚