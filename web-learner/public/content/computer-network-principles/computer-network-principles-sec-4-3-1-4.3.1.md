好的，我们紧接 “4.3.1 第一步 (建连)：三次握手建立信任” 这一主题，开始我们的内容。

---

TCP 连接的建立过程，常被生动地比喻为一次严谨的“电话沟通”。在拨通电话后，你（客户端）需要先问一句“喂，能听到吗？”，对方（服务器）回答“能听到，你能听到我吗？”，最后你再回应一句“我也能听到”，至此，双方才确信通话信道已经建立，可以开始正式交谈。这个过程，就是 TCP 的“三次握手”，它确保了通信双方都具备发送和接收数据的能力。

### 握手三部曲：SYN, SYN-ACK, ACK

三次握手的核心在于交换三个关键的 TCP 报文段，并在此过程中同步双方的初始序列号（Initial Sequence Number, ISN）。序列号是 TCP 实现可靠传输的基石，我们将在后续小节深入探讨，现在只需理解它是一个用于标识数据字节流顺序的随机数。

让我们通过一个清晰的流程图和分步解析，来揭开这三次握手的神秘面纱。

```mermaid
sequenceDiagram
    participant 客户端 as Client
    participant 服务器 as Server

    Note left of Server: 服务器处于 LISTEN (监听) 状态
    
    Client->>Server: 1. SYN (seq=x)\nNote right of Client: 发送连接请求\n进入 SYN-SENT 状态

    Server-->>Client: 2. SYN-ACK (seq=y, ack=x+1)\nNote left of Server: 收到请求，同意连接\n进入 SYN-RECEIVED 状态

    Client->>Server: 3. ACK (seq=x+1, ack=y+1)\nNote right of Client: 确认收到服务器的同意\n进入 ESTABLISHED 状态
    
    Note left of Server: 收到最终确认
进入 ESTABLISHED 状态
    
    Note over Client, Server: 连接已建立，可以进行双向数据传输
```

#### 第一次握手 (SYN)：客户端请求建立连接

1.  **动作**：客户端打算与服务器建立连接，它会创建一个 TCP 报文段。
2.  **报文段关键标志**：
    *   `SYN` (Synchronize Sequence Numbers) 标志位置为 `1`。这表明这是一个连接请求报文。
    *   客户端会选择一个随机的初始序列号 `seq=x`，并将其包含在报文段的序列号字段中。
3.  **状态变化**：发送后，客户端进入 `SYN-SENT`（同步已发送）状态，并等待服务器的确认。

#### 第二次握手 (SYN-ACK)：服务器确认并响应

1.  **动作**：服务器接收到客户端的 SYN 报文后，如果同意建立连接，就会分配 TCP 缓存和变量，并向客户端发送一个响应报文段。
2.  **报文段关键标志**：
    *   `SYN` 标志位置为 `1`，因为服务器也需要同步自己的初始序列号。
    *   `ACK` (Acknowledgement) 标志位置为 `1`，表示这是一个确认报文。
    *   服务器选择自己的随机初始序列号 `seq=y`。
    *   确认号字段 `ack` 被设置为 `x+1`。这个值表示“我已成功收到你的序列号 `x`，我期望收到的下一个字节的序列号是 `x+1`”。
3.  **状态变化**：发送后，服务器进入 `SYN-RECEIVED`（同步已接收）状态。

这个报文段非常巧妙，它同时完成了两件事：对客户端请求的确认（ACK），以及服务器自身的同步请求（SYN）。

#### 第三次握手 (ACK)：客户端最终确认

1.  **动作**：客户端收到服务器的 SYN-ACK 报文段后，会检查确认号 `ack` 是否为 `x+1`。如果正确，它会向服务器发送最后一个确认报文段。
2.  **报文段关键标志**：
    *   `ACK` 标志位置为 `1`。
    *   序列号 `seq` 设置为 `x+1`（因为它是在第一次握手 `seq=x` 之后发送的第一个字节）。
    *   确认号 `ack` 设置为 `y+1`，表示“我已成功收到你的序列号 `y`，我期望收到的下一个字节的序列号是 `y+1`”。
3.  **状态变化**：
    *   客户端发送此报文段后，连接建立，进入 `ESTABLISHED`（已建立）状态，并可以立即开始发送数据。
    *   服务器收到这个 ACK 报文段后，也进入 `ESTABLISHED` 状态。

至此，一个可靠的、全双工的 TCP 连接就正式建立起来了。

> **⚠️ 常见误区：为什么必须是“三次”握手，而不是两次？**
>
> 这是TCP面试中的经典问题。核心原因是为了**防止已失效的连接请求报文段突然又传送到了服务器，从而产生错误**。
>
> 想象一个场景：客户端发送了一个 SYN 请求（我们称之为 SYN-old），但由于网络拥堵，它迟迟没有到达服务器。客户端等不及了，超时重传，发送了一个新的 SYN 请求（SYN-new），这次成功建立了连接，传输数据，然后断开。一段时间后，那个迷路的 SYN-old 终于到达了服务器。
>
> *   **如果是两次握手**：服务器收到 SYN-old 后，会误认为是一个新的连接请求，于是立即分配资源并向客户端发送确认。但此时的客户端早已“心有所属”或已经结束了会话，它会忽略这个确认，导致服务器单方面地开启了一个连接，白白浪费资源，这就是所谓的“半连接”状态。
> *   **有了三次握手**：服务器收到 SYN-old 后，会回复一个 SYN-ACK。客户端收到后，发现自己并未发起这个连接请求（因为它会检查本地的连接状态），于是不会发送第三次的 ACK。服务器在等待一段时间后收不到 ACK，就会知道这是一个无效请求，从而释放资源，避免了浪费。第三次握手起到了一个最终的、双向的确认作用，确保连接的建立是双方当前共同的意愿。

### 本节小结

通过三次握手，TCP 在客户端和服务器之间建立了一个坚固的信任基础。这个过程的核心目标可以归纳为：

*   **确认双方的收发能力**：客户端知道服务器能收能发，服务器也知道客户端能收能发。
*   **同步初始序列号 (ISN)**：双方就数据传输的起始点达成一致，为后续的有序传输和可靠性机制（如重传、流量控制）铺平了道路。
*   **避免历史连接请求的干扰**：第三次握手是防止服务器为空等一个早已失效的连接请求而浪费资源的关键防线。

现在，连接这第一步已经稳稳迈出。接下来，我们将深入探讨数据是如何在这个已建立的可靠通道上进行传输的。